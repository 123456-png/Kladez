{% extends "kladez_app/base.html" %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h2>

        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–µ–π –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π -->
        <div style="display: flex; background: #f8f9fa; padding: 0.25rem; border-radius: 4px;">
            <a href="?tab=table{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
               style="padding: 0.5rem 1rem; background: {% if not show_analytics %}#3498db{% else %}transparent{% endif %}; color: {% if not show_analytics %}white{% else %}#333{% endif %}; border-radius: 3px; text-decoration: none;">
                üìã –¢–∞–±–ª–∏—Ü–∞ —Ä–∞–±–æ—Ç
            </a>
            <a href="?tab=analytics{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
               style="padding: 0.5rem 1rem; background: {% if show_analytics %}#3498db{% else %}transparent{% endif %}; color: {% if show_analytics %}white{% else %}#333{% endif %}; border-radius: 3px; text-decoration: none;">
                üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
            </a>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
    <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
        <form method="get" style="display: flex; gap: 1rem; align-items: end;">
            <input type="hidden" name="tab" value="{{ show_analytics|yesno:'analytics,table' }}">

            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">–°:</label>
                <input type="date" name="date_from" value="{{ date_from }}" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">–ü–æ:</label>
                <input type="date" name="date_to" value="{{ date_to }}" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <button type="submit" style="padding: 0.5rem 1rem; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>
                <a href="?tab={{ show_analytics|yesno:'analytics,table' }}" style="padding: 0.5rem 1rem; background: #95a5a6; color: white; border: none; border-radius: 4px; text-decoration: none; display: inline-block; margin-left: 0.5rem;">
                    –°–±—Ä–æ—Å–∏—Ç—å
                </a>
            </div>
        </form>
    </div>

    {% if not show_analytics %}
        <!-- –†–ï–ñ–ò–ú –¢–ê–ë–õ–ò–¶–´ –†–ê–ë–û–¢ -->
        {% include 'kladez_app/works_table.html' %}
    {% else %}
        <!-- –†–ï–ñ–ò–ú –ê–ù–ê–õ–ò–¢–ò–ö–ò -->
        <div id="analytics-content">

            <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div style="background: #e8f5e8; padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #27ae60;">
                        {{ analytics_data.total_works }}
                    </div>
                    <div style="color: #7f8c8d; margin-top: 0.5rem;">
                        –í—Å–µ–≥–æ —Ä–∞–±–æ—Ç
                    </div>
                </div>

                <div style="background: #e8f4fd; padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #3498db;">
                        {{ analytics_data.total_revenue|floatformat:0 }}
                    </div>
                    <div style="color: #7f8c8d; margin-top: 0.5rem;">
                        –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ (‚ÇΩ)
                    </div>
                </div>

                <div style="background: #fff3cd; padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #e67e22;">
                        {{ analytics_data.avg_revenue_per_work|floatformat:0 }}
                    </div>
                    <div style="color: #7f8c8d; margin-top: 0.5rem;">
                        –°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (‚ÇΩ)
                    </div>
                </div>

                <div style="background: #f8d7da; padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #e74c3c;">
                        {{ analytics_data.by_category_count|length }}
                    </div>
                    <div style="color: #7f8c8d; margin-top: 0.5rem;">
                        –ö–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞–±–æ—Ç
                    </div>
                </div>
            </div>

            {% if analytics_data.table_data %}
                <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–∏–ø–∞ –¥–∏–∞–≥—Ä–∞–º–º—ã -->
                <div style="display: flex; justify-content: center; margin-bottom: 2rem;">
                    <div style="display: flex; background: #f8f9fa; padding: 0.25rem; border-radius: 4px;">
                        <button type="button" onclick="switchChart('count')" id="btn-count" style="padding: 0.5rem 1rem; background: #27ae60; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            –ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ä–∞–±–æ—Ç
                        </button>
                        <button type="button" onclick="switchChart('revenue')" id="btn-revenue" style="padding: 0.5rem 1rem; background: transparent; color: #333; border: none; border-radius: 3px; cursor: pointer;">
                            –ü–æ –≤—ã—Ä—É—á–∫–µ
                        </button>
                        <button type="button" onclick="switchChart('average')" id="btn-average" style="padding: 0.5rem 1rem; background: transparent; color: #333; border: none; border-radius: 3px; cursor: pointer;">
                            –ü–æ —Å—Ä–µ–¥–Ω–µ–º—É —á–µ–∫—É
                        </button>
                    </div>
                </div>

                <div style="display: flex; flex-wrap: wrap; gap: 2rem; margin-bottom: 2rem; align-items: flex-start;"> <!-- –ò–∑–º–µ–Ω–µ–Ω–æ align-items -->
    <div style="flex: 1; min-width: 300px;">
        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h3 style="margin-bottom: 1rem; text-align: center;" id="chart-title">
                –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ä–∞–±–æ—Ç
            </h3>
            <div style="position: relative; height: 300px;"> <!-- –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã -->
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>

    <div style="flex: 1; min-width: 300px;">
        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h3 style="margin-bottom: 1rem; text-align: center;" id="detail-title">
                –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            </h3>
            <div id="category-details" style="min-height: 300px; color: #7f8c8d; padding: 1rem;"> <!-- –£–±—Ä–∞–ª flex —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ -->
                <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
                    –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —Å–µ–∫—Ç–æ—Ä –¥–∏–∞–≥—Ä–∞–º–º—ã –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
                </div>
            </div>
        </div>
    </div>
</div>

                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 1rem;">–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>

                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 1px solid #ddd;">–ö–æ–ª-–≤–æ —Ä–∞–±–æ—Ç</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 1px solid #ddd;">–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 1px solid #ddd;">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (‚ÇΩ)</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 1px solid #ddd;">–î–æ–ª—è –≤ –≤—ã—Ä—É—á–∫–µ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in analytics_data.table_data %}
                                <tr style="cursor: pointer;" onclick="showCategoryDetails('{{ item.name }}')">
                                    <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div style="width: 12px; height: 12px; border-radius: 50%; background: {{ item.color }};"></div>
                                            {{ item.name }}
                                        </div>
                                    </td>
                                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">
                                        {{ item.count }}
                                    </td>
                                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">
                                        {{ item.revenue|floatformat:0 }}
                                    </td>
                                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">
                                        {{ item.avg|floatformat:0 }}
                                    </td>
                                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">
                                        {{ item.share|floatformat:1 }}%
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% else %}
                <div style="text-align: center; padding: 3rem; color: #7f8c8d;">
                    <h3 style="color: #95a5a6;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</h3>
                    <p style="margin-top: 1rem;">–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞–±–æ—Ç—ã –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É</p>
                    <a href="?tab=table" style="display: inline-block; margin-top: 1rem; padding: 0.5rem 1.5rem; background: #3498db; color: white; border-radius: 4px; text-decoration: none;">
                        –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–∞–±–ª–∏—Ü–µ —Ä–∞–±–æ—Ç
                    </a>
                </div>
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º
    const analyticsData = {{ analytics_data_json|safe }};

    console.log("Analytics data:", analyticsData); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

    let currentChartType = 'count';
    let pieChart = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã
    function initChart(chartType = 'count') {
        currentChartType = chartType;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        ['count', 'revenue', 'average'].forEach(type => {
            const btn = document.getElementById(`btn-${type}`);
            if (btn) {
                btn.style.background = type === chartType ?
                    (type === 'count' ? '#27ae60' : type === 'revenue' ? '#3498db' : '#e67e22') :
                    'transparent';
                btn.style.color = type === chartType ? 'white' : '#333';
            }
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const titles = {
            'count': '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ä–∞–±–æ—Ç',
            'revenue': '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤—ã—Ä—É—á–∫–µ',
            'average': '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É —á–µ–∫—É'
        };
        if (document.getElementById('chart-title')) {
            document.getElementById('chart-title').textContent = titles[chartType];
        }

        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        let data = [];
        let labels = [];
        let colors = [];
        let tooltipData = [];

        if (chartType === 'count') {
            data = analyticsData.by_category_count.map(item => item.value);
            labels = analyticsData.by_category_count.map(item => item.name);
            colors = analyticsData.by_category_count.map(item => item.color);
            tooltipData = analyticsData.by_category_count;
        } else if (chartType === 'revenue') {
            data = analyticsData.by_category_revenue.map(item => item.value);
            labels = analyticsData.by_category_revenue.map(item => item.name);
            colors = analyticsData.by_category_revenue.map(item => item.color);
            tooltipData = analyticsData.by_category_revenue;
        } else if (chartType === 'average') {
            data = analyticsData.by_category_avg.map(item => item.value);
            labels = analyticsData.by_category_avg.map(item => item.name);
            colors = analyticsData.by_category_avg.map(item => item.color);
            tooltipData = analyticsData.by_category_avg;
        }

        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—É—é –¥–∏–∞–≥—Ä–∞–º–º—É, –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (pieChart) {
            pieChart.destroy();
        }

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É
        const ctx = document.getElementById('pieChart');
        if (!ctx) return;

        pieChart = new Chart(ctx.getContext('2d'), {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                let total = 0;

                                if (chartType === 'count') {
                                    total = analyticsData.total_works;
                                    return total > 0 ? `${label}: ${value} —Ä–∞–±–æ—Ç (${((value/total)*100).toFixed(1)}%)` : `${label}: ${value} —Ä–∞–±–æ—Ç`;
                                } else if (chartType === 'revenue') {
                                    total = analyticsData.total_revenue;
                                    return total > 0 ? `${label}: ${value.toFixed(0)} ‚ÇΩ (${((value/total)*100).toFixed(1)}%)` : `${label}: ${value.toFixed(0)} ‚ÇΩ`;
                                } else {
                                    return `${label}: ${value.toFixed(0)} ‚ÇΩ –≤ —Å—Ä–µ–¥–Ω–µ–º`;
                                }
                            }
                        }
                    }
                },
                onClick: function(evt, elements) {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        showCategoryDetails(labels[index]);
                    }
                },
                onHover: function(evt, elements) {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        showCategoryDetails(labels[index], true);
                    }
                }
            }
        });
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –¥–∏–∞–≥—Ä–∞–º–º—ã
    function switchChart(chartType) {
        initChart(chartType);
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    function showCategoryDetails(categoryName, isHover = false) {
        if (!categoryName) return;

        let categoryData = null;

        // –ò—â–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ by_category_count (—Ç–∞–º –µ—Å—Ç—å repair_types)
        categoryData = analyticsData.by_category_count.find(item => item.name === categoryName);

        if (!categoryData) return;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        if (document.getElementById('detail-title')) {
            document.getElementById('detail-title').textContent = categoryName;
        }

        // –°–æ–∑–¥–∞–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é
        let detailsHtml = '';

        if (categoryData.repair_types && categoryData.repair_types.length > 0) {
            detailsHtml = `
                <div style="width: 100%;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid #eee;">
                        <span style="font-weight: bold;">–í–∏–¥ —Ä–∞–±–æ—Ç</span>
                        <span style="font-weight: bold;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
                        <span style="font-weight: bold;">–í—ã—Ä—É—á–∫–∞</span>
                    </div>
            `;

            categoryData.repair_types.forEach(repair => {
                detailsHtml += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem; padding: 0.25rem 0;">
                        <span>${repair.name}</span>
                        <span>${repair.count}</span>
                        <span>${parseFloat(repair.revenue).toFixed(0)} ‚ÇΩ</span>
                    </div>
                `;
            });

            detailsHtml += '</div>';
        } else {
            detailsHtml = `
                <div style="text-align: center; color: #7f8c8d;">
                    <p>–ù–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</p>
                </div>
            `;
        }

        if (document.getElementById('category-details')) {
            document.getElementById('category-details').innerHTML = detailsHtml;
        }

        // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ö–æ–≤–µ—Ä, —Å–∫—Ä–æ–ª–ª–∏–º –∫ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
        if (!isHover) {
            const detailsElement = document.getElementById('category-details');
            if (detailsElement) {
                detailsElement.scrollIntoView({ behavior: 'smooth' });
            }
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        if ({{ show_analytics|yesno:"true,false" }} && analyticsData.table_data && analyticsData.table_data.length > 0) {
            initChart('count');
        }
    });
</script>
{% endblock %}