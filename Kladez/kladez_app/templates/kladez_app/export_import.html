{% extends "kladez_app/base.html" %}

{% block title %}–≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö | –ö–ª–∞–¥–µ–∑—å{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <h1>–≠–∫—Å–ø–æ—Ä—Ç –∏ –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h1>
        <p style="color: #7f8c8d; margin-bottom: 2rem;">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ä–∞–±–æ—Ç—ã –∏–∑ —Ñ–∞–π–ª–æ–≤</p>
    </div>

    <!-- –≠–∫—Å–ø–æ—Ä—Ç -->
    <div class="card">
        <h2 style="margin-bottom: 1rem;">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
        <p style="margin-bottom: 1.5rem;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤–∞—à–∏—Ö —Ä–∞–±–æ—Ç:</p>

        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <a href="/api/completed-works/export_excel/" class="btn-excel" 
               style="display: inline-flex; align-items: center; padding: 0.75rem 1.5rem; background: #27ae60; color: white; border-radius: 4px; text-decoration: none; font-weight: bold;">
                <span style="margin-right: 0.5rem;">üìä</span> Excel (.xlsx)
            </a>
            
            <a href="/api/completed-works/export_csv/" class="btn-csv"
               style="display: inline-flex; align-items: center; padding: 0.75rem 1.5rem; background: #3498db; color: white; border-radius: 4px; text-decoration: none; font-weight: bold;">
                <span style="margin-right: 0.5rem;">üìÑ</span> CSV
            </a>
            
            <a href="/api/completed-works/export_json/" class="btn-json"
               style="display: inline-flex; align-items: center; padding: 0.75rem 1.5rem; background: #9b59b6; color: white; border-radius: 4px; text-decoration: none; font-weight: bold;">
                <span style="margin-right: 0.5rem;">üî§</span> JSON
            </a>
        </div>
        
        <p style="margin-top: 1rem; color: #95a5a6; font-size: 0.9rem;">
            <small>Excel —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ª–∏—Å—Ç —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π.</small>
        </p>
    </div>

    <!-- –ò–º–ø–æ—Ä—Ç -->
    <div class="card">
        <h2 style="margin-bottom: 1rem;">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
        <p style="margin-bottom: 1rem;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel –∏–ª–∏ CSV —Ñ–∞–π–ª –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Ä–∞–±–æ—Ç:</p>

        <form id="importForm" enctype="multipart/form-data" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            {% csrf_token %}
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <input type="file" name="file" accept=".xlsx,.csv" required
                       style="flex: 1; min-width: 200px; padding: 0.75rem; border: 2px dashed #ddd; border-radius: 4px; background: white;">
                <button type="submit" class="btn-import"
                        style="padding: 0.75rem 2rem; background: #e67e22; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                    üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
                </button>
            </div>
        </form>

        <div id="importResult" style="display: none; margin-bottom: 1.5rem;"></div>

        <p style="margin-bottom: 1rem; color: #95a5a6; font-size: 0.9rem;">
            <small>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: .xlsx, .csv. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏: –î–∞—Ç–∞, –ú–∞—Ä–∫–∞, –ú–æ–¥–µ–ª—å, –í–∏–¥—ã —Ä–∞–±–æ—Ç, –°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±)</small>
        </p>

        <div>
            <a href="/static/sample_import.xlsx" 
               style="display: inline-flex; align-items: center; padding: 0.75rem 1.5rem; background: #3498db; color: white; border-radius: 4px; text-decoration: none; font-weight: bold;">
                <span style="margin-right: 0.5rem;">üìã</span> –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω
            </a>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="card">
        <h2 style="margin-bottom: 1rem;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
        <div id="stats" style="padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
            <div style="display: flex; align-items: center; justify-content: center; min-height: 100px;">
                <div style="text-align: center; color: #95a5a6;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚è≥</div>
                    –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∏–º–ø–æ—Ä—Ç–∞
    document.getElementById('importForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const resultDiv = document.getElementById('importResult');
        const submitBtn = this.querySelector('button[type="submit"]');

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
        const originalText = submitBtn.textContent;
        submitBtn.textContent = '–ò–º–ø–æ—Ä—Ç...';
        submitBtn.disabled = true;

        resultDiv.innerHTML = `
            <div style="background: #fff3cd; color: #856404; padding: 1rem; border-radius: 8px; border-left: 4px solid #f39c12;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span>‚è≥</span>
                    <strong>–ò–¥–µ—Ç –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö...</strong>
                </div>
                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
            </div>
        `;
        resultDiv.style.display = 'block';

        try {
            const response = await fetch('/api/completed-works/import_excel/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const data = await response.json();

            if (response.ok) {
                resultDiv.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 1rem; border-radius: 8px; border-left: 4px solid #27ae60;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span>‚úÖ</span>
                            <strong>${data.message}</strong>
                        </div>
                        ${data.errors ? `
                            <div style="margin-top: 0.5rem; padding: 0.75rem; background: #f8d7da; border-radius: 4px;">
                                <strong>–û—à–∏–±–∫–∏:</strong>
                                <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem;">
                                    ${data.errors.map(error => `<li>${error}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
                loadStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            } else {
                resultDiv.innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 8px; border-left: 4px solid #e74c3c;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span>‚ùå</span>
                            <strong>–û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</strong>
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 8px; border-left: 4px solid #e74c3c;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>üåê</span>
                        <strong>–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}</strong>
                    </div>
                </div>
            `;
        } finally {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function loadStats() {
        const statsDiv = document.getElementById('stats');

        try {
            const response = await fetch('/api/completed-works/statistics/');
            const data = await response.json();

            statsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                    <div style="text-align: center; padding: 1.5rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="font-size: 2.5rem; font-weight: bold; color: #2c3e50;">${data.total_works}</div>
                        <div style="color: #7f8c8d; margin-top: 0.5rem;">–í—Å–µ–≥–æ —Ä–∞–±–æ—Ç</div>
                    </div>
                    
                    <div style="text-align: center; padding: 1.5rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="font-size: 2.5rem; font-weight: bold; color: #27ae60;">${data.total_revenue.toLocaleString()} ‚ÇΩ</div>
                        <div style="color: #7f8c8d; margin-top: 0.5rem;">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</div>
                    </div>
                    
                    <div style="text-align: center; padding: 1.5rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="font-size: 2.5rem; font-weight: bold; color: #3498db;">${Math.round(data.average_per_work).toLocaleString()} ‚ÇΩ</div>
                        <div style="color: #7f8c8d; margin-top: 0.5rem;">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
                    </div>
                </div>
                
                ${data.by_category && data.by_category.length > 0 ? `
                    <div style="margin-top: 2rem;">
                        <h3 style="margin-bottom: 1rem;">–†–∞–±–æ—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${data.by_category.map(cat => `
                                <span style="padding: 0.5rem 1rem; background: ${cat.category_color || '#3498db'}; color: white; border-radius: 4px; font-size: 0.9rem;">
                                    ${cat.category_name}: ${cat.count}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        } catch (error) {
            statsDiv.innerHTML = `
                <div style="text-align: center; color: #e74c3c;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ùå</div>
                    –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                </div>
            `;
        }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadStats();
</script>
{% endblock %}